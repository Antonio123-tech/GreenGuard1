<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>GreenGuard â€” Smart Plant Care Device</title>
<meta name="description" content="Interactive plant-care demo with species presets, camera capture, and goal progress bars."/>
<style>
  :root{
    --pastel:#E7F7EA; --pastel-2:#DFF1E3;
    --olive:#6B8E23; --olive-2:#556B2F;
    --ink:#0F2A1D; --accent:#8FD19E; --accent-2:#B8E6C3;
    --glass:rgba(255,255,255,.46); --shadow:0 10px 35px rgba(31,78,47,.18);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font:16px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    -webkit-text-size-adjust:100%;
    background:
      radial-gradient(1400px 800px at 20% -10%, #fff, #ffffff00 60%),
      radial-gradient(1000px 600px at 120% 10%, #fff, #ffffff00 50%),
      linear-gradient(180deg,var(--pastel),var(--pastel-2));
    overflow-x:hidden;
  }

  /* Environment banner (in-app/file/non-HTTPS) */
  .env-banner{
    position:sticky; top:0; z-index:60; margin:0; padding:10px 14px;
    background:#fff3cd; border-bottom:1px solid #ffe69c; color:#664d03; font-size:14px;
    display:none; align-items:center; justify-content:space-between; gap:12px
  }
  .env-banner strong{font-weight:800}
  .env-banner button{
    border:1px solid rgba(107,142,35,.25); background:#fff; padding:6px 10px; border-radius:10px; font-weight:700; cursor:pointer
  }

  /* Background canvas */
  #bg-canvas{
    position:fixed; inset:0;
    z-index:-1; pointer-events:none; filter:saturate(1.1) hue-rotate(-5deg) opacity:.5
  }

  /* Sticky header */
  header{
    position:sticky; top:0; z-index:50;
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.55));
    border-bottom:1px solid rgba(107,142,35,.15)
  }
  .nav{max-width:1200px; margin:auto; padding:10px 18px; display:flex; align-items:center; gap:18px}
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; color:var(--olive-2)}
  .brand .logo{
    width:38px;height:38px;border-radius:12px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    background:conic-gradient(from 40deg,var(--accent),var(--pastel),var(--accent-2),var(--accent));
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.7),0 6px 16px rgba(107,142,35,.25)
  }

  nav a{text-decoration:none;color:var(--ink);font-weight:600;padding:8px 10px;border-radius:9px}
  nav a:hover{background:rgba(107,142,35,.10)}
  .spacer{flex:1}

  .status-chips{display:flex; gap:8px; align-items:center; margin-left:auto}
  .chip-sm{font-size:12px; padding:4px 8px; border-radius:999px; background:#fff;border:1px solid rgba(107,142,35,.18); display:flex; align-items:center; gap:6px}
  .dot{width:8px; height:8px; border-radius:50%; background:#bbb}
  .dot.on{background:#6B8E23}
  .mode-pill{font-weight:700}

  .cta{background:linear-gradient(135deg,var(--olive),var(--olive-2));color:#fff;border:none;border-radius:999px;padding:10px 16px;font-weight:800;box-shadow:0 10px 24px rgba(107,142,35,.35);cursor:pointer;-webkit-tap-highlight-color:transparent}

  /* Settings dropdown */
  .settings-wrap{position:relative}
  .settings-btn{
    border:1px solid rgba(107,142,35,.25); background:#fff; color:var(--ink);
    padding:8px 12px; border-radius:12px; font-weight:700; display:flex; align-items:center; gap:8px;
    box-shadow:0 6px 16px rgba(107,142,35,.10); cursor:pointer; -webkit-tap-highlight-color:transparent
  }
  .gear{width:16px;height:16px; display:inline-block; border-radius:50%; box-shadow:inset 0 0 0 2px var(--olive-2); position:relative}
  .gear::before,.gear::after{content:''; position:absolute; inset:-4px; border-radius:50%; border:2px dashed var(--olive-2); opacity:.7}
  .settings-menu{
    position:absolute; right:0; top:calc(100% + 8px);
    width:260px; background:#fff; border:1px solid rgba(107,142,35,.15); border-radius:14px;
    box-shadow:0 16px 40px rgba(0,0,0,.18); padding:12px; display:none; z-index:60
  }
  .settings-menu.open{display:block}
  .settings-menu h4{margin:4px 0 8px; color:var(--olive-2)}
  .row-setting{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 6px}
  .row-setting + .row-setting{border-top:1px dashed rgba(107,142,35,.15)}
  .row-setting label{font-weight:700}
  .switch{position:relative; width:44px; height:24px}
  .switch input{position:absolute; opacity:0; width:0; height:0}
  .slider{position:absolute; inset:0; background:#e6eedf; border-radius:999px; box-shadow:inset 0 1px 3px rgba(0,0,0,.15)}
  .slider::before{
    content:''; position:absolute; height:18px; width:18px; left:3px; top:3px; background:#fff; border-radius:50%;
    box-shadow:0 2px 6px rgba(0,0,0,.2); transition:transform .2s ease
  }
  .switch input:checked + .slider{background:#8FD19E}
  .switch input:checked + .slider::before{transform:translateX(20px)}
  .mode-group{display:grid; grid-template-columns:1fr 1fr; gap:6px}
  .mode-option{border:1px solid rgba(107,142,35,.18); border-radius:10px; padding:8px; display:flex; align-items:center; gap:8px}
  .mode-option input{accent-color:#6B8E23}

  /* Main content */
  section{max-width:1200px;margin:24px auto;padding:0 18px}
  .sim{display:grid;grid-template-columns:1.15fr .85fr;gap:18px;align-items:stretch}
  .panel{background:linear-gradient(180deg,#ffffff99,#ffffff55);border:1px solid rgba(107,142,35,.15);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .controls .row{display:grid;grid-template-columns:170px 1fr auto;align-items:center;gap:12px;margin:12px 0}
  .controls label{font-weight:800;color:var(--olive-2)}
  select{padding:8px 10px;border-radius:10px;border:1px solid rgba(107,142,35,.25);background:#fff}
  .badge{font-weight:800;color:var(--olive-2);min-width:90px;text-align:right}
  .subtle{font-size:12px;opacity:.78}
  .targets{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 0}
  .chip{font-size:12px;padding:6px 8px;border-radius:999px;background:#fff;border:1px solid rgba(107,142,35,.18)}

  /* Progress bars (mobile-safe) */
  .metric{display:grid; gap:6px; margin:14px 0 20px; will-change:transform}
  .metric-header{display:flex;justify-content:space-between;align-items:end;gap:8px}
  .metric-header .name{font-weight:800;color:var(--olive-2)}
  .metric-header .vals{font-variant-numeric:tabular-nums; font-size:13px}
  .bar{position:relative;height:14px;border-radius:10px;background:rgba(107,142,35,.15);overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.08); transform:translateZ(0)}
  .band{position:absolute;top:0;bottom:0;border-radius:10px;background:linear-gradient(90deg,#BEEBD0,#8FD19E);opacity:.95; transform:translateZ(0)}
  .sensor-pin{position:absolute;top:-4px;width:0;height:22px;display:none; transform:translateZ(0)}
  .sensor-pin::after{content:'';position:absolute;left:-6px;top:2px;width:10px;height:10px;border-radius:50%;background:#556B2F;box-shadow:0 0 0 3px #fff,0 2px 6px rgba(0,0,0,.25)}
  .sensor-label{margin-top:2px;font-size:12px;opacity:.9;display:flex;gap:12px;flex-wrap:wrap}

  /* Live scene */
  .plant-scene{position:relative;border-radius:var(--radius);overflow:hidden;min-height:380px;background:
      radial-gradient(600px 220px at 50% -10%,#ffffffaa,#ffffff00),
      linear-gradient(180deg,var(--accent-2),var(--pastel-2));display:grid;place-items:center}
  .pot{width:240px;height:240px;position:relative;transform-style:preserve-3d;animation:float 6s ease-in-out infinite}
  @keyframes float{0%,100%{transform:translateY(0) rotateX(8deg) rotateZ(-1deg)}50%{transform:translateY(-8px) rotateX(8deg) rotateZ(1deg)}}
  .plant-svg{width:100%;height:100%}

  .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
  .card2{background:#fff;border-radius:16px;border:1px solid rgba(107,142,35,.12);padding:14px;box-shadow:var(--shadow)}
  .card2 h3{margin:0 0 6px;color:var(--olive-2)}
  canvas{width:100%;height:160px;display:block; touch-action:manipulation}
  .info{margin-top:28px;display:grid;gap:14px}
  details.info-block{border:1px solid rgba(107,142,35,.14);background:rgba(255,255,255,.85);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow)}
  summary{cursor:pointer;font-weight:800;color:var(--olive-2)}

  /* Camera modal */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
  .modal .box{background:#fff;border-radius:16px;max-width:640px;width:92%;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .modal .close{position:absolute;right:14px;top:10px;border:none;background:transparent;font-size:22px;cursor:pointer}

  footer{margin-top:50px;padding:26px 18px;text-align:center;color:#2d3e33}

  @media (max-width:980px){
    .sim{grid-template-columns:1fr}
    .cards{grid-template-columns:1fr 1fr}
    .status-chips{display:none}
  }
  @media (max-width:640px){.cards{grid-template-columns:1fr}}
</style>
</head>
<body>

<noscript>
  <div style="padding:12px 14px;background:#fff3cd;border-bottom:1px solid #ffe69c;color:#664d03;">
    Full features require JavaScript. Please open this page in Safari/Chrome over HTTPS.
  </div>
</noscript>

<canvas id="bg-canvas" aria-hidden="true"></canvas>

<header>
  <div class="nav">
    <div class="brand"><div class="logo" aria-hidden="true"></div><span>GreenGuard</span></div>
    <nav>
      <a href="#simulator">Simulator</a>
      <a href="#nutrients">Nutrients</a>
      <a href="#growth">Growth</a>
      <a href="#health">Health</a>
      <a href="#care">Care</a>
    </nav>

    <div class="spacer"></div>

    <div class="status-chips" aria-live="polite">
      <span class="chip-sm"><span class="dot" id="dotWifi" aria-hidden="true"></span>Wi-Fi</span>
      <span class="chip-sm"><span class="dot" id="dotBt" aria-hidden="true"></span>BT</span>
      <span class="chip-sm mode-pill" id="chipMode">Mode: Automatic</span>
    </div>

    <div class="settings-wrap">
     <button class="settings-btn" id="settingsBtn" type="button"
        aria-haspopup="true" aria-expanded="false" aria-controls="settingsMenu">
  <span class="gear" aria-hidden="true"></span> Settings
</button>
      <div class="settings-menu" id="settingsMenu" role="menu" aria-label="Settings">
        <h4>Connectivity</h4>
        <div class="row-setting">
          <label for="wifiToggle">Wi-Fi</label>
          <div class="switch">
            <input id="wifiToggle" type="checkbox" checked aria-checked="true" role="switch" />
            <span class="slider" aria-hidden="true"></span>
          </div>
        </div>
        <div class="row-setting">
          <label for="btToggle">Bluetooth</label>
          <div class="switch">
            <input id="btToggle" type="checkbox" checked aria-checked="true" role="switch" />
            <span class="slider" aria-hidden="true"></span>
          </div>
        </div>

        <h4>Mode</h4>
        <div class="mode-group" role="radiogroup" aria-label="Control mode">
          <label class="mode-option"><input type="radio" name="mode" value="automatic" checked/> Automatic</label>
          <label class="mode-option"><input type="radio" name="mode" value="manual"/> Manual</label>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
          <button id="settingsClose" class="cta" style="padding:8px 12px">Done</button>
        </div>
      </div>
    </div>


</header>

<!-- Environment banner (appears automatically if limited viewer detected) -->
<div id="envBanner" class="env-banner" role="status" aria-live="polite">
  <span><strong>Limited viewer detected:</strong> For full features (charts, progress bars, camera), open in Safari/Chrome over HTTPS.</span>
  <div style="display:flex;gap:8px">
    <button id="openExtern">Open externally</button>
    <button id="dismissEnv">Dismiss</button>
  </div>
</div>

<section id="simulator" aria-label="Interactive simulator">
  <div class="sim">
    <!-- Controls -->
    <div class="panel controls">
      <h2 style="margin:0 0 6px">Live Plant Environment</h2>
      <p class="subtle" style="margin:0 0 10px">Choose a plant. Goal bands change instantly. Pins show sensor readings (â€” until connected).</p>

      <div class="row" style="margin-top:4px">
        <label for="plantType">Plant</label>
        <select id="plantType">
          <optgroup label="Aroids & Popular Houseplants">
            <option value="monstera">Monstera deliciosa</option>
            <option value="ficus_lyrata">Fiddle-Leaf Fig (Ficus lyrata)</option>
            <option value="rubber_plant">Rubber Plant (Ficus elastica)</option>
            <option value="calathea">Calathea</option>
            <option value="peace_lily">Peace Lily (Spathiphyllum)</option>
            <option value="pothos">Pothos (Epipremnum aureum)</option>
            <option value="philodendron">Philodendron hederaceum</option>
            <option value="zz">ZZ Plant (Zamioculcas)</option>
            <option value="snake_plant">Snake Plant (Sansevieria)</option>
            <option value="pilea">Pilea peperomioides</option>
            <option value="boston_fern">Boston Fern (Nephrolepis)</option>
          </optgroup>
          <optgroup label="Succulents & Cacti">
            <option value="aloe">Aloe vera</option>
            <option value="jade">Jade Plant (Crassula ovata)</option>
            <option value="haworthia">Haworthia</option>
            <option value="cactus">Cactus (Echinopsis)</option>
            <option value="succulent_mix">Succulent Mix</option>
          </optgroup>
          <optgroup label="Flowering / Epiphytes">
            <option value="orchid">Orchid (Phalaenopsis)</option>
            <option value="anthurium">Anthurium</option>
            <option value="hibiscus">Hibiscus (indoor)</option>
          </optgroup>
          <optgroup label="Herbs & Aromatics">
            <option value="basil">Basil</option>
            <option value="mint">Mint</option>
            <option value="rosemary">Rosemary</option>
            <option value="lavender">Lavender</option>
            <option value="parsley">Parsley</option>
            <option value="coriander">Coriander/Cilantro</option>
          </optgroup>
          <optgroup label="Fruiting / Acid-Lovers">
            <option value="tomato">Tomato</option>
            <option value="strawberry">Strawberry</option>
            <option value="blueberry">Blueberry (acid-loving)</option>
            <option value="hydrangea">Hydrangea (acid-tolerant)</option>
            <option value="lemon">Lemon (container)</option>
          </optgroup>
          <optgroup label="Custom">
            <option value="other">Other (Camera)</option>
          </optgroup>
        </select>
        <span class="badge" id="presetName">Monstera deliciosa</span>
      </div>

      <div class="targets" id="targetChips"></div>
      <div id="metrics"></div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap">
        <button id="mockBtn" class="cta" style="padding:8px 14px">Mock sensor data</button>
        <span class="subtle">Use this to preview pins. Replace with your device feed later.</span>
      </div>

      <p id="advice" style="margin:10px 0 0;font-weight:600">Tip: Most houseplants enjoy 18â€“27Â°C and 40â€“60% humidity.</p>
    </div>

    <!-- Live scene -->
    <div class="panel plant-scene">
      <div class="pot" aria-hidden="true">
        <svg class="plant-svg" viewBox="0 0 300 300">
          <defs>
            <linearGradient id="potg2" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#6B8E23"/><stop offset="1" stop-color="#556B2F"/></linearGradient>
            <filter id="softGlow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>
          <ellipse cx="150" cy="230" rx="120" ry="14" fill="#213224" opacity=".25"/>
          <path d="M40 110 h220 l-24 110 a160 40 0 0 1 -172 0 z" fill="url(#potg2)" filter="url(#softGlow)"/>
          <ellipse cx="150" cy="110" rx="95" ry="22" fill="#2f3e2c" opacity=".35"/>
          <path id="stem" d="M150 110 C145 95 145 70 150 58" stroke="#2f5d35" stroke-width="8" fill="none"/>
          <ellipse id="leafL" cx="130" cy="68" rx="18" ry="34" fill="#8FD19E" transform="rotate(-18 130 68)"/>
          <ellipse id="leafR" cx="170" cy="66" rx="18" ry="34" fill="#8FD19E" transform="rotate(18 170 66)"/>
          <rect x="138" y="78" width="24" height="50" rx="9" fill="#ffffff" stroke="#6B8E23"/>
          <circle id="led" cx="150" cy="86" r="5" fill="#B8E6C3" stroke="#6B8E23"/>
          <g id="face" transform="translate(120,150)">
            <circle id="mood" r="28" fill="#B8E6C3" stroke="#6B8E23"/>
            <circle cx="-10" cy="-4" r="3" fill="#234"/>
            <circle cx="10" cy="-4" r="3" fill="#234"/>
            <path id="mouth" d="M-10 8 Q0 14 10 8" stroke="#234" stroke-width="3" fill="none" stroke-linecap="round"/>
          </g>
        </svg>
      </div>
    </div>
  </div>

  <div class="info">
    <details class="info-block"><summary>Temperature</summary><div class="subtle">â€¢ Optimal range depends on species â€¢ Extremes harm leaves/roots/flowers â€¢ Day/night swing matters</div></details>
    <details class="info-block"><summary>Humidity</summary><div class="subtle">â€¢ Affects transpiration â€¢ Tropicals high, deserts low â€¢ Too dry â†’ brown tips; too humid â†’ fungi</div></details>
    <details class="info-block"><summary>Water &amp; Soil</summary><div class="subtle">â€¢ Under/over-watering both bad â€¢ Frequency = plant + pot + season â€¢ Drainage is vital â€¢ pH controls nutrient uptake</div></details>
  </div>
</section>

<section id="nutrients" aria-label="Nutrients">
  <h2 style="color:var(--olive-2);margin:0 0 10px">Nutrients Dashboard</h2>
  <p class="subtle" style="margin-top:0">NPK adjusts with stage & pH; secondary nutrients shown for context.</p>
  <div class="cards">
    <div class="card2"><h3>NPK (Macronutrients)</h3><canvas id="npkChart" width="400" height="220"></canvas><p class="subtle" style="margin:.3rem 0 0">N: leaf growth â€¢ P: roots/flowers â€¢ K: resilience</p></div>
    <div class="card2"><h3>Secondary Nutrients</h3><canvas id="secChart" width="400" height="220"></canvas><p class="subtle" style="margin:.3rem 0 0">Ca: cell walls â€¢ Mg: chlorophyll â€¢ S: proteins</p></div>
    <div class="card2"><h3>Fertilizers</h3><p class="subtle"><strong>Organic:</strong> compost, manure, seaweed. <strong>Delivery:</strong> slow-release, liquid, foliar.</p></div>
    <div class="card2"><h3>Nutrient Lock</h3><p class="subtle">Wrong pH prevents uptake. Many houseplants prefer ~6â€“7. Use sulfur (down) or lime (up) cautiously.</p></div>
  </div>
</section>

<section id="growth" aria-label="Growth stages">
  <h2 style="color:var(--olive-2);margin:0 0 10px">Growth Stages</h2>
  <div class="cards">
    <div class="card2"><h3>Germination</h3><p class="subtle">Moist, warm medium. Gentle light.</p></div>
    <div class="card2"><h3>Vegetative</h3><p class="subtle">More light, steady nitrogen, regular watering.</p></div>
    <div class="card2"><h3>Flowering</h3><p class="subtle">Phosphorus support, careful moisture, stable temps.</p></div>
    <div class="card2"><h3>Fruiting / Seeding</h3><p class="subtle">Balanced NPK, consistent light, avoid stress.</p></div>
  </div>
</section>

<section id="health" aria-label="Plant health & diseases">
  <h2 style="color:var(--olive-2);margin:0 0 10px">Plant Health & Diseases</h2>
  <div class="cards">
    <div class="card2"><h3>Pests â€” Insects</h3><p class="subtle">Aphids â€¢ Spider mites â€¢ Whiteflies â€¢ Mealybugs</p></div>
    <div class="card2"><h3>Pests â€” Others</h3><p class="subtle">Snails â€¢ Slugs â€¢ Nematodes</p></div>
    <div class="card2"><h3>Diseases â€” Fungal</h3><p class="subtle">Powdery mildew â€¢ Root rot â€¢ Leaf spot</p></div>
    <div class="card2"><h3>Diseases â€” Bacterial</h3><p class="subtle">Leaf blight â€¢ Wilt</p></div>
    <div class="card2"><h3>Diseases â€” Viral</h3><p class="subtle">Mosaic viruses â€¢ Stunt diseases</p></div>
    <div class="card2"><h3>Air Quality</h3><p class="subtle">Fresh air = COâ‚‚. Dust/smoke & poor airflow hinder respiration; raise fungal risk.</p></div>
  </div>
</section>

<section id="care" aria-label="Care & Maintenance">
  <h2 style="color:var(--olive-2);margin:0 0 10px">Care & Maintenance</h2>
  <div class="cards">
    <div class="card2"><h3>Pruning</h3><p class="subtle">Remove dead/diseased leaves; shape growth; improve airflow.</p></div>
    <div class="card2"><h3>Repotting</h3><p class="subtle">When roots outgrow pot; prevents root-bound plants.</p></div>
  </div>
</section>

<!-- Camera modal -->
<div class="modal" id="cameraModal" aria-hidden="true" role="dialog" aria-label="Capture plant photo">
  <div class="box">
    <button class="close" id="closeCam" aria-label="Close">Ã—</button>
    <h3 style="margin:0 0 10px;color:var(--olive-2)">Take a photo of your plant</h3>
    <p class="subtle" style="margin-top:0">On phones, this opens the camera. On desktop, it opens a file picker.</p>

    <input id="camInput" type="file" accept="image/*" capture="environment"
           style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;" />

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start">
      <label for="camInput" class="cta" id="camLabel" style="padding:8px 14px; display:inline-block; text-align:center; cursor:pointer;">
        Open camera
      </label>
      <img id="camPreview" alt="Your plant preview"
           style="max-width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.08);display:none"/>
    </div>
  </div>
</div>

<footer>Â© <span id="year"></span> GreenGuard â€” Smart Plant Care Device â€¢ Designed with love for plants ðŸŒ±</footer>

<script>

/* Settings: show menu if the wrapper is focused (keyboard/no-JS fallback) */
.settings-wrap:focus-within .settings-menu{ display:block; }
.settings-menu{ z-index: 999; } /* ensure above header/webviews */

/* ===== Quick environment detection (in-app/file/non-HTTPS) ===== */
(function(){
  const ua = navigator.userAgent || navigator.vendor || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua);
  const isInApp = /(FBAN|FBAV|Instagram|Line\/|MicroMessenger|Snapchat|Twitter|TikTok|GSA|Gmail)/i.test(ua);
  const isFile = location.protocol === 'file:';
  const isHTTPS = location.protocol === 'https:';
  var banner = document.getElementById('envBanner');
  var openExtern = document.getElementById('openExtern');
  var dismissEnv = document.getElementById('dismissEnv');
  if ((isIOS && isInApp) || isFile || (!isHTTPS && !location.hostname.includes('localhost'))) {
    if (banner) banner.style.display = 'flex';
  }
  if (openExtern) openExtern.addEventListener('click', function(){ window.open(location.href, '_blank', 'noopener,noreferrer'); }, {passive:true});
  if (dismissEnv) dismissEnv.addEventListener('click', function(){ banner.style.display='none'; }, {passive:true});

  // Camera fallback if capture not allowed here
  var camLabel = document.getElementById('camLabel');
  var camInput = document.getElementById('camInput');
  var hasCapture = 'capture' in document.createElement('input');
  if (camInput && camLabel && (!hasCapture || (!isHTTPS && !location.hostname.includes('localhost')) || (isIOS && isInApp))) {
    camInput.removeAttribute('capture');
    camLabel.textContent = 'Upload photo';
  }
})();

/* ===== Small helpers ===== */
function $(s){ return document.querySelector(s); }
function on(el, type, fn, opts){ if(el){ el.addEventListener(type, fn, opts||{}); } }
function pointer(el, fn){ if(!el) return; el.addEventListener('pointerup', fn); el.addEventListener('click', fn); }
function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }
function pct(val, dm){ var dmin=dm[0], dmax=dm[1]; return ((val-dmin)/(dmax-dmin))*100; }

/* ===== Background leaf particles (DPR canvas) ===== */
(function(){
  var c=document.getElementById('bg-canvas'); if(!c) return;
  var ctx=c.getContext('2d');

  function sizeCanvas(){
    var bb = c.getBoundingClientRect();
    var DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    c.width  = Math.round(bb.width  * DPR);
    c.height = Math.round(bb.height * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  function resize(){ c.style.width='100%'; c.style.height='100%'; sizeCanvas(); }
  resize();
  if (window.ResizeObserver){
    var ro = new ResizeObserver(resize);
    ro.observe(document.documentElement);
  } else {
    window.addEventListener('resize', resize);
  }

  function rand(a,b){ return a+Math.random()*(b-a); }
  function makeLeaf(){ return {x:rand(0,c.width),y:rand(-c.height,0),s:rand(.3,1.2),spx:rand(-.4,.4),spy:rand(.4,1.4),r:rand(0,Math.PI*2),rv:rand(-.01,.01),hue:rand(85,125)}; }
  var leaves=[]; for(var i=0;i<60;i++) leaves.push(makeLeaf());
  function leaf(l){ var w=18*l.s,h=8*l.s; ctx.save(); ctx.translate(l.x,l.y); ctx.rotate(l.r); ctx.fillStyle='hsla('+l.hue+',45%,55%,.55)'; ctx.beginPath(); ctx.moveTo(-w/2,0); ctx.quadraticCurveTo(0,-h,w/2,0); ctx.quadraticCurveTo(0,h,-w/2,0); ctx.fill(); ctx.restore(); }
  (function tick(){ ctx.clearRect(0,0,c.width,c.height); for(var j=0;j<leaves.length;j++){ var l=leaves[j]; l.x+=l.spx; l.y+=l.spy; l.r+=l.rv; if(l.y>c.height+20||l.x<-40||l.x>c.width+40){ leaves[j]=makeLeaf(); leaves[j].y=-20; leaves[j].x=rand(0,c.width);} leaf(l);} requestAnimationFrame(tick); })();
})();

/* ===== Domains & presets ===== */
var DOMAINS={ temp:[0,45,'Â°C'], hum:[0,100,'%'], moist:[0,100,'%'], ph:[4,9,' pH'] };
var PRESETS={
  monstera:{name:'Monstera deliciosa',temp:[18,27],hum:[60,80],moist:[50,65],ph:[5.5,7.0]},
  ficus_lyrata:{name:'Fiddle-Leaf Fig',temp:[18,26],hum:[40,60],moist:[40,55],ph:[6.0,7.0]},
  rubber_plant:{name:'Rubber Plant',temp:[18,27],hum:[40,60],moist:[40,55],ph:[6.0,7.5]},
  calathea:{name:'Calathea',temp:[18,27],hum:[60,80],moist:[50,65],ph:[6.0,6.8]},
  peace_lily:{name:'Peace Lily',temp:[18,27],hum:[50,70],moist:[50,70],ph:[5.8,6.8]},
  pothos:{name:'Pothos',temp:[18,27],hum:[40,60],moist:[40,60],ph:[6.1,6.8]},
  philodendron:{name:'Philodendron hederaceum',temp:[18,27],hum:[50,70],moist:[45,60],ph:[5.8,6.8]},
  zz:{name:'ZZ Plant',temp:[18,27],hum:[30,50],moist:[25,40],ph:[6.0,7.5]},
  snake_plant:{name:'Snake Plant (Sansevieria)',temp:[16,30],hum:[20,50],moist:[20,35],ph:[6.0,7.8]},
  pilea:{name:'Pilea peperomioides',temp:[16,26],hum:[40,60],moist:[40,55],ph:[6.0,7.0]},
  boston_fern:{name:'Boston Fern',temp:[16,24],hum:[60,80],moist:[55,70],ph:[5.5,6.5]},
  aloe:{name:'Aloe vera',temp:[16,30],hum:[20,40],moist:[20,35],ph:[6.0,7.8]},
  jade:{name:'Jade Plant',temp:[16,27],hum:[20,40],moist:[20,35],ph:[6.0,7.5]},
  haworthia:{name:'Haworthia',temp:[16,27],hum:[20,40],moist:[20,30],ph:[6.0,7.5]},
  cactus:{name:'Cactus (Echinopsis)',temp:[18,32],hum:[15,35],moist:[15,30],ph:[5.5,7.5]},
  succulent_mix:{name:'Succulent Mix',temp:[16,30],hum:[20,40],moist:[20,35],ph:[6.0,7.8]},
  orchid:{name:'Orchid (Phalaenopsis)',temp:[18,29],hum:[60,80],moist:[35,55],ph:[5.5,6.5]},
  anthurium:{name:'Anthurium',temp:[18,27],hum:[60,80],moist:[45,60],ph:[5.5,6.5]},
  hibiscus:{name:'Hibiscus (indoor)',temp:[18,27],hum:[50,70],moist:[50,65],ph:[6.0,7.0]},
  basil:{name:'Basil',temp:[18,27],hum:[45,60],moist:[45,60],ph:[6.0,7.0]},
  mint:{name:'Mint',temp:[15,24],hum:[50,70],moist:[55,70],ph:[6.0,7.0]},
  rosemary:{name:'Rosemary',temp:[12,24],hum:[30,50],moist:[30,45],ph:[6.5,7.8]},
  lavender:{name:'Lavender',temp:[12,24],hum:[30,50],moist:[30,45],ph:[6.5,8.0]},
  parsley:{name:'Parsley',temp:[12,22],hum:[45,65],moist:[45,60],ph:[6.0,7.0]},
  coriander:{name:'Coriander/Cilantro',temp:[10,21],hum:[45,65],moist:[45,60],ph:[6.2,6.8]},
  tomato:{name:'Tomato',temp:[18,27],hum:[50,70],moist:[50,65],ph:[6.0,6.8]},
  strawberry:{name:'Strawberry',temp:[15,24],hum:[50,70],moist:[55,70],ph:[5.5,6.5]},
  blueberry:{name:'Blueberry (acid-loving)',temp:[13,24],hum:[50,70],moist:[55,70],ph:[4.5,5.5]},
  hydrangea:{name:'Hydrangea (acid-tolerant)',temp:[15,24],hum:[50,70],moist:[50,65],ph:[5.0,6.2]},
  lemon:{name:'Lemon (container)',temp:[18,27],hum:[40,60],moist:[45,60],ph:[5.5,6.5]},
  other:{name:'Custom',temp:[18,27],hum:[40,60],moist:[40,60],ph:[6.0,7.0]}
};

/* ===== UI refs ===== */
var plantType=$('#plantType'), presetName=$('#presetName'), targetChips=$('#targetChips'), metrics=$('#metrics');
var mood=$('#mood'), mouth=$('#mouth'), led=$('#led');
document.getElementById('year').textContent=new Date().getFullYear();

/* ===== Build progress bars ===== */
function barHTML(key, title, range){
  var d = DOMAINS[key], dmin=d[0], dmax=d[1], suf=d[2];
  var left = clamp(pct(range[0],[dmin,dmax]),0,100);
  var right= clamp(pct(range[1],[dmin,dmax]),0,100);
  var width=Math.max(4,right-left);
  return '<div class="metric" data-key="'+key+'">'+
      '<div class="metric-header"><div class="name">'+title+
      '</div><div class="vals">Target: '+range[0]+'â€“'+range[1]+suf+'</div></div>'+
      '<div class="bar"><div class="band" style="left:'+left+'%;width:'+width+'%"></div>'+
      '<div class="sensor-pin"></div></div>'+
      '<div class="sensor-label"><span class="chip">Sensor: <span class="sensor-val">â€”</span>'+suf.trim()+
      '</span><span class="subtle">Awaiting deviceâ€¦</span></div></div>';
}

function renderFor(key){
  var r=PRESETS[key];
  if(presetName) presetName.textContent=r.name;
  if(targetChips) targetChips.innerHTML=
    '<span class="chip">Target Â°C: '+r.temp[0]+'â€“'+r.temp[1]+'</span>'+
    '<span class="chip">Humidity %: '+r.hum[0]+'â€“'+r.hum[1]+'</span>'+
    '<span class="chip">Moisture %: '+r.moist[0]+'â€“'+r.moist[1]+'</span>'+
    '<span class="chip">pH: '+r.ph[0]+'â€“'+r.ph[1]+'</span>';
  if(metrics) metrics.innerHTML=
    barHTML('temp','Temperature',r.temp)+
    barHTML('hum','Humidity',r.hum)+
    barHTML('moist','Soil Moisture',r.moist)+
    barHTML('ph','Soil pH',r.ph);
  if(mood) mood.setAttribute('fill','#B8E6C3');
  if(mouth) mouth.setAttribute('d','M-10 8 Q0 14 10 8');
  if(led) led.setAttribute('fill','#8FD19E');
}

/* ===== Sensor updates ===== */
function setSensorValue(key, value){
  var metric = metrics ? metrics.querySelector('.metric[data-key="'+key+'"]') : null;
  if(!metric) return;
  var pin = metric.querySelector('.sensor-pin');
  var label = metric.querySelector('.sensor-val');
  var d = DOMAINS[key], dmin=d[0], dmax=d[1];

  if(value==null || isNaN(value)){
    label.textContent = 'â€”';
    pin.style.display='none';
    return;
  }
  label.textContent = (key==='ph'? Number(value).toFixed(1) : Math.round(value));
  var left = clamp(pct(Number(value),[dmin,dmax]),0,100);
  pin.style.left = left+'%';
  pin.style.display = 'block';
}

/* ===== Mood from sensors ===== */
function refreshMoodFromSensors(){
  var r=PRESETS[plantType.value];
  function read(k){
    var m=metrics.querySelector('.metric[data-key="'+k+'"] .sensor-val');
    var txt=m?m.textContent:'â€”'; return txt==='â€”'? null : parseFloat(txt);
  }
  var T=read('temp'), H=read('hum'), M=read('moist'), P=read('ph');
  var score=100; function fall(v,lo,hi,k){ return v<lo?(lo-v)*k : v>hi?(v-hi)*k : 0; }
  if(T!=null) score-=fall(T,r.temp[0],r.temp[1],2.2);
  if(H!=null) score-=fall(H,r.hum[0],r.hum[1],1.7);
  if(M!=null) score-=fall(M,r.moist[0],r.moist[1],1.5);
  if(P!=null){ if(P<r.ph[0]) score-=(r.ph[0]-P)*10; if(P>r.ph[1]) score-=(P-r.ph[1])*10; }
  score=clamp(Math.round(score),0,100);
  var hue=90+30*(score/100);
  if(mood) mood.setAttribute('fill','hsl('+hue+',55%,78%)');
  if(mouth) mouth.setAttribute('d', score>=70 ? 'M-10 8 Q0 14 10 8' : (score>=40 ? 'M-10 10 Q0 10 10 10' : 'M-10 14 Q0 6 10 14'));
  if(led) led.setAttribute('fill', score>=70 ? '#8FD19E' : (score>=40 ? '#FFD46B' : '#FF9BA5'));

  var tips=[];
  if(T!=null){ if(T<r.temp[0]-2) tips.push('Too cool.'); if(T>r.temp[1]+2) tips.push('Heat stress.'); }
  if(H!=null){ if(H<r.hum[0]-5) tips.push('Air too dry.'); if(H>r.hum[1]+5) tips.push('High humidity.'); }
  if(M!=null){ if(M<r.moist[0]-5) tips.push('Soil too dry.'); if(M>r.moist[1]+5) tips.push('Soil too wet.'); }
  if(P!=null){ if(P<r.ph[0]) tips.push('pH low.'); if(P>r.ph[1]) tips.push('pH high.'); }
  var advice = document.getElementById('advice');
  if(advice) advice.textContent = tips.length? tips.join(' ') : 'All set for now.';
}

/* ===== Plant change (iOS-safe) ===== */
['change','input'].forEach(function(ev){
  on(plantType, ev, function(){
    var val=plantType.value;
    renderFor(val);
    if(val==='other'){ openCameraModal(); }
    ['temp','hum','moist','ph'].forEach(function(k){ setSensorValue(k,null); });
    refreshMoodFromSensors();
  }, {passive:true});
});

/* ===== Mock sensors ===== */
function randR(r,j){ var lo=r[0], hi=r[1]; var v=lo+Math.random()*(hi-lo); return v + (Math.random()*2-1)*(j||0); }
var mockBtn = document.getElementById('mockBtn');
pointer(mockBtn,function(){
  var r=PRESETS[plantType.value];
  var t=randR(r.temp,1), h=randR(r.hum,2), m=randR(r.moist,3), p=((r.ph[0]+r.ph[1])/2 + (Math.random()*0.6-0.3));
  setSensorValue('temp',t); setSensorValue('hum',h); setSensorValue('moist',m); setSensorValue('ph',p);
  refreshMoodFromSensors();
});

/* ===== Camera modal ===== */
var camModal=document.getElementById('cameraModal'), camInput=document.getElementById('camInput'), camPreview=document.getElementById('camPreview');
function openCameraModal(){ if(camModal) camModal.style.display='flex'; }
var closeCam=document.getElementById('closeCam'); if(closeCam) closeCam.addEventListener('click',function(){ camModal.style.display='none'; });
if(camInput) camInput.addEventListener('change',function(){
  var file=camInput.files && camInput.files[0]; if(!file) return;
  var url=URL.createObjectURL(file); camPreview.src=url; camPreview.style.display='block';
});

/* ===== Charts with DPR scaling (no optional chaining) ===== */
function scaleCanvas(canvas, ctx){
  var bb = canvas.getBoundingClientRect();
  var dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  canvas.width  = Math.max(1, Math.round(bb.width  * dpr));
  canvas.height = Math.max(1, Math.round(bb.height * dpr));
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
function drawBars(ctx,data,labels){
  var c=ctx.canvas; scaleCanvas(c, ctx);
  var W=c.clientWidth, H=c.clientHeight;
  ctx.clearRect(0,0,W,H);
  var keys=Object.keys(data),gap=18,barW=Math.max(10,(W-gap*(keys.length+1))/keys.length);
  ctx.textAlign='center';ctx.font='bold 14px system-ui';
  for(var i=0;i<keys.length;i++){
    var k=keys[i], v=data[k], x=gap+i*(barW+gap), h=(H-50)*(v/100), y=H-30-h;
    var grd=ctx.createLinearGradient(0,y,0,y+h); grd.addColorStop(0,'#8FD19E'); grd.addColorStop(1,'#6B8E23');
    ctx.fillStyle=grd; ctx.fillRect(x,y,barW,h);
    ctx.fillStyle='#234'; ctx.fillText(v.toFixed(0)+'%',x+barW/2,Math.max(12,y-6)); ctx.fillText(labels[i],x+barW/2,H-10);
  }
}
var npkCanvas = document.getElementById('npkChart');
var secCanvas = document.getElementById('secChart');
var npkCtx = npkCanvas ? npkCanvas.getContext('2d') : null;
var secCtx = secCanvas ? secCanvas.getContext('2d') : null;
var npk={N:60,P:50,K:55}, sec={Ca:40,Mg:50,S:35};
function renderCharts(){ if(npkCtx) drawBars(npkCtx,npk,['N','P','K']); if(secCtx) drawBars(secCtx,sec,['Ca','Mg','S']); }
renderCharts();
if (window.ResizeObserver){
  var roCharts = new ResizeObserver(renderCharts);
  if(npkCanvas) roCharts.observe(npkCanvas);
  if(secCanvas) roCharts.observe(secCanvas);
} else {
  window.addEventListener('resize', renderCharts);
}
window.addEventListener('orientationchange', renderCharts);

/* ===== Settings menu (touch + click + fallback) ===== */
var settingsBtn   = document.getElementById('settingsBtn');
var settingsMenu  = document.getElementById('settingsMenu');
var settingsClose = document.getElementById('settingsClose');
var wifiToggle    = document.getElementById('wifiToggle');
var btToggle      = document.getElementById('btToggle');
var dotWifi       = document.getElementById('dotWifi');
var dotBt         = document.getElementById('dotBt');
var chipMode      = document.getElementById('chipMode');

function openSettings(){
  if(!settingsMenu) return;
  settingsMenu.classList.add('open');
  settingsBtn.setAttribute('aria-expanded','true');
}
function closeSettings(){
  if(!settingsMenu) return;
  settingsMenu.classList.remove('open');
  settingsBtn.setAttribute('aria-expanded','false');
}
function toggleSettings(e){
  if(e){ e.preventDefault(); e.stopPropagation(); }
  if(!settingsMenu) return;
  var isOpen = settingsMenu.classList.toggle('open');
  settingsBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
  if(isOpen){
    // focus first interactive element for accessibility
    var first = settingsMenu.querySelector('input,button,[tabindex]');
    if(first) first.focus();
  }
}

// open/close (cover both touch + mouse)
['click','touchend','pointerup'].forEach(function(ev){
  if(settingsBtn) settingsBtn.addEventListener(ev, toggleSettings, {passive:false});
  if(settingsClose) settingsClose.addEventListener(ev, function(e){ e.preventDefault(); closeSettings(); }, {passive:false});
});

// close when tapping outside
document.addEventListener('mousedown', function(e){
  if(!settingsMenu || !settingsBtn) return;
  if(!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) closeSettings();
});
document.addEventListener('touchstart', function(e){
  if(!settingsMenu || !settingsBtn) return;
  if(!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) closeSettings();
}, {passive:true});

// Esc to close
document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeSettings(); });

// connectivity state â†’ header dots
function syncConnectivity(){
  if(wifiToggle){ wifiToggle.setAttribute('aria-checked', wifiToggle.checked ? 'true':'false'); if(dotWifi) dotWifi.classList.toggle('on', !!wifiToggle.checked); }
  if(btToggle){   btToggle.setAttribute('aria-checked',   btToggle.checked   ? 'true':'false'); if(dotBt)   dotBt.classList.toggle('on',   !!btToggle.checked); }
}
if(wifiToggle) wifiToggle.addEventListener('change', syncConnectivity);
if(btToggle)   btToggle.addEventListener('change',   syncConnectivity);
syncConnectivity();

// mode chips + disabling mock in Manual
function getMode(){ var r=document.querySelector('input[name="mode"]:checked'); return r ? r.value : 'automatic'; }
function applyMode(){
  var mode = getMode();
  if(chipMode) chipMode.textContent = 'Mode: ' + (mode.charAt(0).toUpperCase()+mode.slice(1));
  var mockBtnEl=document.getElementById('mockBtn');
  if(mockBtnEl){ mockBtnEl.disabled = (mode==='manual'); mockBtnEl.style.opacity = (mode==='manual')? .6 : 1; }
}
Array.prototype.forEach.call(document.querySelectorAll('input[name="mode"]'), function(r){
  r.addEventListener('change', applyMode);
});
applyMode();

/* ===== Smooth scroll ===== */
var tryDemoBtn = document.getElementById('tryDemoBtn');
pointer(tryDemoBtn,function(){ var s=document.getElementById('simulator'); if(s) s.scrollIntoView({behavior:'smooth'}); });

/* ===== Boot ===== */
renderFor('monstera');
</script>
</body>
</html>